<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	  xmlns:jsf="http://xmlns.jcp.org/jsf"
	  xmlns:h="http://xmlns.jcp.org/jsf/html"
	  xmlns:f="http://xmlns.jcp.org/jsf/core"
	  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	  xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp"
	  xmlns:r="http://richfaces.org"
	  xmlns:s="http://shop.de">
<!--
 * Copyright (C) 2013 Juergen Zimmermann, Hochschule Karlsruhe
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

	<body jsf:id="body">
		<ui:composition template="/WEB-INF/resources/templates/desktop/shop.xml">
			<ui:define name="metadata">
				<f:viewParam id="kundeIdMeta" name="kundeId"/>
				<f:event type="preRenderView" listener="#{kundeModel.loadKundeById}"/>
			</ui:define>

			<ui:param name="pageTitle" value="#{msgKv['viewKunde.title']}"/>
		
			<ui:define name="main">
				<section id="sucheSection">
					<form jsf:id="form" jsf:prependId="false" jsf:rendered="#{request.isUserInRole('admin') or request.isUserInRole('mitarbeiter')}">
						<r:focus id="formFocus"/>

						<r:panel id="suchePanel" header="#{msgKv['viewKunde.sucheNeu']}">
							<h:panelGrid id="suchePanelGrid" columns="4">
								<label id="kundeIdLabelSuche" for="kundeIdSucheInput">
									#{msgKv['viewKunde.kundenr']}
								</label>

								<r:autocomplete id="kundeIdSuche"
												value="#{kundeModel.kundeIdStr}"
												mode="cachedAjax"
												minChars="2"
												autocompleteMethod="#{kundeModel.findKundenByIdPrefix}"
												required="true"
												requiredMessage="#{msgKv['viewKunde.kundenr.required']}"/> 

								<r:commandButton id="findButton"
												 action="#{kundeModel.findKundeById}"
												 value="#{msgKv['viewKunde.submit']}"
												 render="gesuchterKundePanel fehlermeldungKundeId"/>

								<ez:waiting id="inBearbeitung" msg="#{msgKv['viewKunde.inBearbeitung']}"/>
								<!--
								<r:status id="statusWaiting">
									<f:facet name="start">
										<span id="waitingGroup">
											<img jsf:id="waitingGif" jsf:name="waiting.gif" jsf:library="images"/>
											#{msgKv['viewKunde.inBearbeitung']}
										</span>
									</f:facet>
								</r:status>
								-->

							</h:panelGrid>

							<r:messages id="fehlermeldungKundeId" for="kundeIdInput"/>
						</r:panel>
					</form>
				</section>
		
				<r:outputPanel id="gesuchterKundePanel">
					<section id="kundeSection">
						<form jsf:id="kundeForm" jsf:prependId="false">
							<c:set var="privatkunde" value="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}" scope="view"/>
							<c:set var="firmenkunde" value="#{kundeModel.kunde.class.simpleName eq 'Firmenkunde'}" scope="view"/>

							<r:tabPanel id="tabPanel" switchType="client" rendered="#{not empty kundeModel.kunde}">
								<r:tab id="stammdatenTab">
									<f:facet name="header">
											<img jsf:id="stammdatenGif" jsf:name="stammdaten.gif" jsf:library="images"/>
											#{' '}
											#{msgKv['viewKunde.kunde.stammdaten']}
									</f:facet>

									<h:panelGrid id="stammdatenGrid" columns="2">
										<label jsf:id="kundeIdLabel">#{msgKv['viewKunde.kundenr']}</label>
										<h:outputText id="kundeId" value="#{kundeModel.kunde.id}"/>

										<label jsf:id="nachnameLabel">#{msgKv['viewKunde.nachname']}</label>
										<h:outputText id="nachname" value="#{kundeModel.kunde.nachname}"/>

										<label jsf:id="vornameLabel">#{msgKv['viewKunde.vorname']}</label>
										<h:outputText id="vorname" value="#{kundeModel.kunde.vorname}"/>

										<label jsf:id="seitLabel">#{msgKv['viewKunde.seit']}</label>
										<h:outputText id="seit" value="#{kundeModel.kunde.seit}">
											<f:convertDateTime type="date" dateStyle="long"/>
										</h:outputText>

										<label jsf:id="umsatzLabel">#{msgKv['viewKunde.umsatz']}</label>
										<h:outputText id="umsatz" value="#{kundeModel.kunde.umsatz}">
											<f:convertNumber type="currency"
															 currencyCode="EUR"/>
										</h:outputText>

										<label jsf:id="emailLabel">#{msgKv['viewKunde.email']}</label>
										<h:outputText id="email" value="#{kundeModel.kunde.email}"/>

										<label jsf:id="kundenartLabel">#{msgKv['viewKunde.kundenart']}</label>
										<h:outputText id="kundenart" value="#{kundeModel.kunde.class.simpleName eq 'Firmenkunde' ? msgKv['viewKunde.firmenkunde'] : msgKv['viewKunde.privatkunde']}"/>

										<label jsf:id="rabattLabel">#{msgKv['viewKunde.rabatt']}</label>
										<h:outputText id="rabatt" value="#{kundeModel.kunde.rabatt}">
											<f:convertNumber type="percent" maxFractionDigits="2"/>
										</h:outputText>

										<label jsf:id="familienstandLabel" jsf:rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">#{msgKv['viewKunde.familienstand']}</label>
										<h:panelGroup id="familienstand" rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">
											<h:outputText id="ledig" value="#{msgKv['viewKunde.familienstand.ledig']}" rendered="#{kundeModel.kunde.familienstand eq 'LEDIG'}"/>
											<h:outputText id="verheiratet" value="#{msgKv['viewKunde.familienstand.verheiratet']}" rendered="#{kundeModel.kunde.familienstand eq 'VERHEIRATET'}"/>
											<h:outputText id="geschieden" value="#{msgKv['viewKunde.familienstand.geschieden']}" rendered="#{kundeModel.kunde.familienstand eq 'GESCHIEDEN'}"/>
											<h:outputText id="verwitwet" value="#{msgKv['viewKunde.familienstand.verwitwet']}" rendered="#{kundeModel.kunde.familienstand eq 'VERWITWET'}"/>
										</h:panelGroup>

										<label jsf:id="geschlechtLabel" jsf:rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">#{msgKv['viewKunde.geschlecht']}</label>
										<h:panelGroup id="geschlecht" rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">
											<h:outputText id="weiblich" value="#{msgKv['viewKunde.geschlecht.weiblich']}" rendered="#{kundeModel.kunde.geschlecht eq 'WEIBLICH'}"/>
											<h:outputText id="maennlich" value="#{msgKv['viewKunde.geschlecht.maennlich']}" rendered="#{kundeModel.kunde.geschlecht eq 'MAENNLICH'}"/>
										</h:panelGroup>

										<label jsf:id="newsletterLabel">#{msgKv['viewKunde.newsletter']}</label>
										<input jsf:id="newsletter" type="checkbox" jsf:value="#{kundeModel.kunde.newsletter}" disabled="disabled" readonly="readonly"/>

										<label jsf:id="hobbiesLabel" jsf:rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">#{msgKv['viewKunde.hobbies']}</label>
										<h:selectManyCheckbox value="#{kundeModel.kunde.hobbies}"
															  layout="pageDirection"
															  disabled="true"
															  readonly="true"
															  rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">
											<f:selectItem itemValue="SPORT"
														  itemLabel="#{msgKv['viewKunde.sport']}"/>
											<f:selectItem itemValue="LESEN" 
														  itemLabel="#{msgKv['viewKunde.lesen']}"/>
											<f:selectItem itemValue="REISEN" 
														  itemLabel="#{msgKv['viewKunde.reisen']}"/>
										</h:selectManyCheckbox>
									</h:panelGrid>
								</r:tab>

								<r:tab id="fileTab" rendered="#{not empty kundeModel.kunde.file}">
									<f:facet name="header">
										<img jsf:id="fileGif" jsf:name="bild.gif" jsf:library="images"/>
										#{' '}
										#{msgKv['viewKunde.kunde.bildVideoAudio']}
									</f:facet>

									<c:choose>
										<c:when test="#{kundeModel.kunde.file.multimediaType eq 'IMAGE'}">
											<img jsf:id="bild" jsf:value="/../filesDb/shop/#{kundeModel.getFilename(kundeModel.kunde.file)}" alt="#{msgKv['viewKunde.kunde.bild.alt']}"/>
										</c:when>

										<c:when test="${kundeModel.kunde.file.multimediaType eq 'VIDEO'}">
											<!-- http://features.encoding.com/html5 -->
											<!-- Funktioniert mit FF und Chrome, nicht mit IE -->
											<video id="video"
												   controls="controls"
												   preload="auto"
												   width="640"
												   height="480">
												<source src="/../filesDb/shop/#{kundeModel.getFilename(kundeModel.kunde.file)}" type="#{kundeModel.kunde.file.mimeType.toString()}" />
											</video>
											
											<!-- Alternative Videoplayer http://html5video.org/wiki/HTML5_Video_Player_Comparison -->
											
											<!-- http://www.videojs.com -->
											<!--
											<link jsf:id="cssVideo" jsf:library="css" jsf:name="video-js.css"/>
											<script jsf:id="jsVideo" jsf:library="js" jsf:name="video.js" rel="stylesheet" type="text/css"/>
											<script>
												videojs.options.flash.swf = "#{resource['js:video-js.swf']}"
											</script>
											<video id="video"
												   class="video-js vjs-default-skin"
												   controls="controls"
												   preload="auto"
												   width="640"
												   height="480"
												   data-setup='{"example_option":true}'>
												<source src="/../filesDb/shop/#{kundeModel.getFilename(kundeModel.kunde.file)}" type="#{kundeModel.kunde.file.mimeType.toString()}" />
											</video>
											-->

											<!-- MediaElement von http://mediaelementjs.com und https://github.com/johndyer/mediaelement/tree/master/build -->
											<!--
											<script jsf:id="jsVideo" jsf:library="js" jsf:name="mediaelement-and-player.min.js"/>
											<link jsf:id="cssVideo" jsf:library="css" jsf:name="mediaelementplayer.css" rel="stylesheet" type="text/css"/>
											<video id="video"
												   controls="controls"
												   width="640"
												   height="480">
												<source src="/../filesDb/shop/#{kundeModel.kunde.file}"
														type="#{kundeModel.kunde.file.mimeType.toString()}"/>
											</video>
											-->
										</c:when>

										<c:when test="#{kundeModel.kunde.file.multimediaType eq 'AUDIO'}">
											TODO: AUDIO
										</c:when>
									</c:choose>
								</r:tab>

								<r:tab id="bestellungenTab" rendered="#{not empty kundeModel.kunde.bestellungen}">
									<f:facet name="header">
										<img jsf:id="bestellungenGif" jsf:name="bestellungen.gif" jsf:library="images"/>
										#{' '}
										#{msgKv['viewKunde.kunde.bestellungen']}
									</f:facet>

									<r:dataTable id="bestellungenTabelle" value="#{kundeModel.kunde.bestellungen}" var="bestellung">
										<f:facet name="header">
											<r:columnGroup id="positionenSpalten">
												<r:column id="artikelIdSpalte">
													#{msgKv['viewKunde.artikel.id']}
												</r:column>
												<r:column id="bezeichnungSpalte">
													#{msgKv['viewKunde.artikel.bezeichnung']}
												</r:column>
												<r:column id="anzahlSpalte">
													#{msgKv['viewKunde.artikel.anzahl']}
												</r:column>
												<r:column id="preisSpalte">
													#{msgKv['viewKunde.artikel.preis']}
												</r:column>
											</r:columnGroup>
										</f:facet>

										<r:column id="togglerSpalte" colspan="4">
											<r:collapsibleSubTableToggler id="subTableToggler"
																		  for="positionenSubtable"
																		  collapsedLabel="#{msgKv['viewKunde.bestellung']} #{bestellung.id}: #{msgKv['viewKunde.bestellung.datum']} #{bestellung.getErzeugt('yyyy-MM-dd')}"
																		  expandedLabel="#{msgKv['viewKunde.bestellung']} #{bestellung.id}: #{msgKv['viewKunde.bestellung.datum']} #{bestellung.getErzeugt('yyyy-MM-dd')} / #{msgKv['viewKunde.bestellung.gesamtbetrag']} #{bestellung.gesamtbetrag}"/>
										</r:column>

										<r:collapsibleSubTable id="positionenSubtable"
															   value="#{s:asList(bestellung.bestellpositionen)}"
															   var="pos"
															   rowClasses="odd-row, even-row"
															   expandMode="client"
															   expanded="#{false}"> <!-- https://issues.jboss.org/browse/RF-10715 -->
											<r:column id="artikelIdSpalteSub">
												#{pos.artikel.id}
											</r:column>

											<r:column id="bezeichnungSpalteSub">
												#{pos.artikel.bezeichnung}
											</r:column>

											<r:column id="anzahlSpalteSub">
												#{pos.anzahl}
											</r:column>

											<r:column id="preisSpalteSub">
												<h:outputText id="preis" value="#{pos.artikel.preis}">
													<f:convertNumber type="currency" currencyCode="EUR" maxFractionDigits="2" minFractionDigits="2"/>
												</h:outputText>
											</r:column>
										</r:collapsibleSubTable>
									</r:dataTable>
								</r:tab>

								<r:tab id="bemerkungenTab" rendered="#{not empty kunde.bemerkungen}">
									<f:facet name="header">
										<img jsf:id="bemerkungenGif" jsf:name="text.gif" jsf:library="images"/>
										#{' '}
										#{msgKv['viewKunde.kunde.bemerkungen']}
									</f:facet>

									<h:outputText id="bemerkungen" value="#{kundeModel.kunde.bemerkungen}" escape="false"/>
								</r:tab>
							</r:tabPanel>

							<h:panelGroup id="buttons" rendered="#{(request.isUserInRole('admin') or request.isUserInRole('mitarbeiter')) and not empty kundeModel.kunde}">
								<a jsf:id="updateButtonPrivatkunde" jsf:action="/rf/kundenverwaltung/updatePrivatkunde"
								   jsf:rendered="#{kundeModel.kunde.class.simpleName eq 'Privatkunde'}">
									<img jsf:id="editIconPrivat" jsf:name="edit.gif" jsf:library="images" jsf:alt="#{msgKv['viewKunde.update.alt']}"/>
								</a>

								<a jsf:id="updateButtonFirmenkunde" jsf:action="/rf/kundenverwaltung/updateFirmenkunde"
								   jsf:rendered="#{kundeModel.kunde.class.simpleName eq 'Firmenkunde'}">
									<img jsf:id="editIconFirmen" jsf:name="edit.gif" jsf:library="images" jsf:alt="#{msgKv['viewKunde.update.alt']}"/>
								</a>

								<h:panelGroup id="deleteButtonGroup" rendered="#{request.isUserInRole('admin')}">
									#{' '}
									<a jsf:id="deleteButton" jsf:action="#{kundeModel.deleteAngezeigtenKunden}"
									   jsf:onclick="return confirm('#{msgKv['viewKunde.deleteKundeBestaetigung']}')">
										<img jsf:id="deleteIcon" jsf:name="delete.gif" jsf:library="images" alt="#{msgKv['viewKunde.deleteButtonAlt']}"/>
									</a>
									#{' '}
									<r:messages id="fehlermeldungDeleteButton" for="deleteButton"/>
								</h:panelGroup>
							</h:panelGroup>
						</form>
					</section>
				</r:outputPanel>
				
				<!--
				<r:log id="log"/>
				-->
			</ui:define>
		</ui:composition>
	</body>
</html>
